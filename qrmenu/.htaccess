# Restaurant Menu System - Apache Configuration

# Enable rewrite engine
RewriteEngine On

# Security Headers
<IfModule mod_headers.c>
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options nosniff
    
    # Prevent framing attacks
    Header always set X-Frame-Options SAMEORIGIN
    
    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"
    
    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Remove server signature
    Header unset Server
    Header unset X-Powered-By
    
    # HSTS for HTTPS (uncomment for production with SSL)
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
</IfModule>

# Hide sensitive files and directories
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

<FilesMatch "\.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist|md|txt)$">
    Require all denied
</FilesMatch>

# Protect config and sensitive files
<Files "config.php">
    Require all denied
</Files>

<Files "database.php">
    Require all denied
</Files>

<Files ".env">
    Require all denied
</Files>

<Files "composer.json">
    Require all denied
</Files>

<Files "package.json">
    Require all denied
</Files>

<Files "readme.md">
    Require all denied
</Files>

# Protect directories
RedirectMatch 404 /\.git
RedirectMatch 404 /\.svn
RedirectMatch 404 /backend/config/
RedirectMatch 404 /backend/logs/
RedirectMatch 404 /backend/cache/

# Prevent access to PHP files in uploads directory
<Directory "backend/uploads">
    <FilesMatch "\.php$">
        Require all denied
    </FilesMatch>
</Directory>

# API Routing
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^backend/api/(.*)$ backend/api/$1 [L,QSA]

# Clean URLs for menu (optional)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^menu/([0-9]+)/?$ index.html?table=$1 [L,QSA]

RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^table/([0-9]+)/?$ index.html?table=$1 [L,QSA]

# Admin area protection
<Directory "admin">
    # IP whitelist for admin (uncomment and add your IPs for extra security)
    # Require ip 127.0.0.1
    # Require ip YOUR_IP_ADDRESS
    
    # Basic auth for admin (optional extra layer)
    # AuthType Basic
    # AuthName "Admin Access"
    # AuthUserFile /path/to/.htpasswd
    # Require valid-user
</Directory>

# File type restrictions
<FilesMatch "\.(php)$">
    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteCond %{REQUEST_METHOD} !^(GET|POST|PUT|DELETE|OPTIONS)$
        RewriteRule .* - [F,L]
    </IfModule>
</FilesMatch>

# Prevent SQL injection attempts
<IfModule mod_rewrite.c>
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*iframe.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*object.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*embed.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} base64_encode.*\(.*\) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} javascript\: [NC,OR]
    RewriteCond %{QUERY_STRING} vbscript\: [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*marquee.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*meta.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*link.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} union.*select.*\( [NC,OR]
    RewriteCond %{QUERY_STRING} \b(INSERT|UPDATE|DELETE|DROP|CREATE|ALTER)\b [NC]
    RewriteRule .* - [F,L]
</IfModule>

# Rate limiting (requires mod_evasive)
<IfModule mod_evasive24.c>
    DOSHashTableSize    2048
    DOSPageCount        2
    DOSSiteCount        50
    DOSPageInterval     1
    DOSSiteInterval     1
    DOSBlockingPeriod   600
    DOSEmailNotify      admin@yourdomain.com
    DOSLogDir           /var/log/mod_evasive
</IfModule>

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Browser Caching
<IfModule mod_expires.c>
    ExpiresActive on
    
    # Images
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    
    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
    ExpiresByType text/javascript "access plus 1 week"
    
    # HTML
    ExpiresByType text/html "access plus 1 hour"
    
    # Fonts
    ExpiresByType application/font-woff "access plus 1 month"
    ExpiresByType application/font-woff2 "access plus 1 month"
    ExpiresByType application/vnd.ms-fontobject "access plus 1 month"
    ExpiresByType font/ttf "access plus 1 month"
    ExpiresByType font/otf "access plus 1 month"
    
    # JSON and XML
    ExpiresByType application/json "access plus 1 hour"
    ExpiresByType application/xml "access plus 1 hour"
    ExpiresByType text/xml "access plus 1 hour"
</IfModule>

# ETag removal
<IfModule mod_headers.c>
    Header unset ETag
</IfModule>
FileETag None

# Prevent hotlinking
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?yourdomain\.com [NC]
    RewriteCond %{REQUEST_URI} \.(jpe?g|png|gif|webp|svg)$ [NC]
    RewriteRule .* - [F,L]
</IfModule>

# Error pages
ErrorDocument 400 /error.html
ErrorDocument 401 /error.html  
ErrorDocument 403 /error.html
ErrorDocument 404 /error.html
ErrorDocument 500 /error.html

# Upload file size limit
LimitRequestBody 10485760 # 10MB

# Disable server signature
ServerSignature Off

# PHP settings (if mod_php is enabled)
<IfModule mod_php7.c>
    php_flag display_errors Off
    php_flag log_errors On
    php_value error_log /var/log/php_errors.log
    php_flag expose_php Off
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
    php_value max_execution_time 30
    php_value max_input_time 30
    php_value memory_limit 256M
    php_flag session.cookie_httponly On
    php_flag session.cookie_secure On
    php_value session.cookie_samesite Strict
</IfModule>

<IfModule mod_php8.c>
    php_flag display_errors Off
    php_flag log_errors On
    php_value error_log /var/log/php_errors.log
    php_flag expose_php Off
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
    php_value max_execution_time 30
    php_value max_input_time 30
    php_value memory_limit 256M
    php_flag session.cookie_httponly On
    php_flag session.cookie_secure On
    php_value session.cookie_samesite Strict
</IfModule>

# Maintenance mode
<IfModule mod_rewrite.c>
    # Uncomment the following lines to enable maintenance mode
    # RewriteCond %{REQUEST_URI} !/maintenance.html$
    # RewriteCond %{REMOTE_ADDR} !^127\.0\.0\.1$
    # RewriteRule .* /maintenance.html [R=503,L]
</IfModule>

# Security by obscurity - hide common files
<FilesMatch "(readme|license|changelog|install|upgrade)">
    Require all denied
</FilesMatch>

# Prevent access to version control files
<FilesMatch "\.(git|svn|hg|bzr)">
    Require all denied
</FilesMatch>

# Block bad bots and scanners
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_USER_AGENT} (nikto|sqlmap|fimap|nessus|whatweb|Openvas) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (<|>|'|%0A|%0D|%27|%3C|%3E|%00|0x00) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (script|javascript|vbscript) [NC]
    RewriteRule .* - [F,L]
</IfModule>

# Block suspicious requests
<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK|OPTIONS|HEAD) [NC]
    RewriteRule .* - [F,L]
    
    RewriteCond %{THE_REQUEST} (\?|\*|%2a)+(%20+|\\s+|%20+\\s+|\\s+%20+|\\s+%20+\\s+)(HTTP|GET|HEAD|POST) [NC,OR]
    RewriteCond %{THE_REQUEST} etc/passwd [NC,OR]
    RewriteCond %{THE_REQUEST} cgi-bin [NC,OR]
    RewriteCond %{THE_REQUEST} (%0A|%0D|\\r|\\n) [NC]
    RewriteRule .* - [F,L]
</IfModule>

# Prevent proxy access
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP:Via} !^$ [OR]
    RewriteCond %{HTTP:Forwarded} !^$ [OR]
    RewriteCond %{HTTP:Useragent-Via} !^$ [OR]
    RewriteCond %{HTTP:X-Forwarded-For} !^$ [OR]
    RewriteCond %{HTTP:X-Forwarded-Host} !^$ [OR]
    RewriteCond %{HTTP:Proxy-Connection} !^$ [OR]
    RewriteCond %{HTTP:Xproxy-Connection} !^$ [OR]
    RewriteCond %{HTTP:HTTP_PC_Remote_Addr} !^$ [OR]
    RewriteCond %{HTTP:HTTP_CLIENT_IP} !^$
    RewriteRule .* - [F,L]
</IfModule>

# Force SSL (uncomment for HTTPS sites)
# <IfModule mod_rewrite.c>
#     RewriteCond %{HTTPS} off
#     RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
# </IfModule>

# Prevent clickjacking
<IfModule mod_headers.c>
    Header always append X-Frame-Options SAMEORIGIN
    Header always append Content-Security-Policy "frame-ancestors 'self'"
</IfModule>